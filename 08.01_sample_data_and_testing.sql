-- ============================================================================
-- Script: 08_sample_data_and_testing.sql
-- Purpose: Insert Sample Data and Test Delta Detection
-- ============================================================================
USE ROLE SYSADMIN;
USE DATABASE FINANCE_DB;
USE SCHEMA BALANCE_SHEET;

-- ============================================================================
-- Step 1: Insert Sample Data into Staging Table
-- ============================================================================

-- Clear any existing staging data
SHOW TABLES;

TRUNCATE TABLE INCOMING_DATA_STAGING;

TRUNCATE TABLE ACTUAL_AA_BALANCE_SHEET;

TRUNCATE TABLE DELTA_EXPORT_HISTORY;

TRUNCATE TABLE DAILY_DELTA_STAGING;

SHOW STAGES;

LS @DELTA_PARQUET_STAGE;

RM @delta_parquet_stage/balance_sheet_delta_20251211.parquet;



-- Insert sample balance sheet data
INSERT INTO INCOMING_DATA_STAGING (
    PORTFOLIO_TICKER, REPORTING_FREQUENCY, REPORTING_CURRENCY, VALUE_DATE,
    PRELIMINARY, SOURCE, ACCT_BASIS, BALANCE_SHEET_TYPE,
    CASH_AND_EQUIVALENTS, SHORT_TERM_INVESTMENTS, ACCOUNTS_RECEIVABLE, INVENTORY,
    PREPAID_EXPENSES, OTHER_CURRENT_ASSETS, TOTAL_CURRENT_ASSETS,
    LONG_TERM_INVESTMENTS, PROPERTY_PLANT_EQUIPMENT, ACCUMULATED_DEPRECIATION,
    INTANGIBLE_ASSETS, GOODWILL, OTHER_LONG_TERM_ASSETS, TOTAL_NON_CURRENT_ASSETS,
    TOTAL_ASSETS, ACCOUNTS_PAYABLE, SHORT_TERM_DEBT, ACCRUED_LIABILITIES,
    DEFERRED_REVENUE, CURRENT_PORTION_LONG_TERM_DEBT, OTHER_CURRENT_LIABILITIES,
    TOTAL_CURRENT_LIABILITIES, LONG_TERM_DEBT, DEFERRED_TAX_LIABILITIES,
    PENSION_LIABILITIES, OTHER_LONG_TERM_LIABILITIES, TOTAL_NON_CURRENT_LIABILITIES,
    TOTAL_LIABILITIES, COMMON_STOCK, PREFERRED_STOCK, ADDITIONAL_PAID_IN_CAPITAL,
    RETAINED_EARNINGS, TREASURY_STOCK, ACCUMULATED_OTHER_COMPREHENSIVE_INCOME,
    MINORITY_INTEREST, TOTAL_SHAREHOLDERS_EQUITY, TOTAL_LIABILITIES_AND_EQUITY
) VALUES
-- Portfolio ABC - Daily GAAP Consolidated
('ABC-001', 'DAILY', 'USD', CURRENT_DATE(), FALSE, 'ERP_SYSTEM', 'GAAP', 'CONSOLIDATED',
 1500000.00, 500000.00, 750000.00, 300000.00, 50000.00, 25000.00, 3125000.00,
 2000000.00, 5000000.00, -1500000.00, 800000.00, 1200000.00, 100000.00, 7600000.00,
 10725000.00, 400000.00, 200000.00, 150000.00, 100000.00, 50000.00, 75000.00, 975000.00,
 3000000.00, 500000.00, 200000.00, 150000.00, 3850000.00, 4825000.00,
 1000000.00, 0.00, 2000000.00, 2500000.00, -100000.00, 400000.00, 100000.00, 5900000.00, 10725000.00),

-- Portfolio ABC - Different Acct Basis (IFRS)
('ABC-001', 'DAILY', 'USD', CURRENT_DATE(), FALSE, 'ERP_SYSTEM', 'IFRS', 'CONSOLIDATED',
 1520000.00, 510000.00, 740000.00, 310000.00, 48000.00, 27000.00, 3155000.00,
 2050000.00, 5100000.00, -1520000.00, 850000.00, 1180000.00, 95000.00, 7755000.00,
 10910000.00, 410000.00, 195000.00, 155000.00, 105000.00, 48000.00, 72000.00, 985000.00,
 3050000.00, 520000.00, 195000.00, 145000.00, 3910000.00, 4895000.00,
 1000000.00, 0.00, 2015000.00, 2600000.00, -100000.00, 400000.00, 100000.00, 6015000.00, 10910000.00),

-- Portfolio DEF - EUR Currency
('DEF-002', 'DAILY', 'EUR', CURRENT_DATE(), FALSE, 'TRADING_SYSTEM', 'GAAP', 'STANDALONE',
 2000000.00, 800000.00, 650000.00, 0.00, 30000.00, 15000.00, 3495000.00,
 1500000.00, 3000000.00, -900000.00, 500000.00, 700000.00, 50000.00, 4850000.00,
 8345000.00, 300000.00, 150000.00, 100000.00, 80000.00, 40000.00, 50000.00, 720000.00,
 2500000.00, 400000.00, 150000.00, 100000.00, 3150000.00, 3870000.00,
 800000.00, 200000.00, 1500000.00, 1800000.00, -50000.00, 175000.00, 50000.00, 4475000.00, 8345000.00),

-- Portfolio GHI - Preliminary Data
('GHI-003', 'MONTHLY', 'GBP', CURRENT_DATE(), TRUE, 'RISK_SYSTEM', 'STAT', 'CONSOLIDATED',
 3000000.00, 1200000.00, 900000.00, 450000.00, 75000.00, 40000.00, 5665000.00,
 3500000.00, 8000000.00, -2400000.00, 1200000.00, 1800000.00, 200000.00, 12300000.00,
 17965000.00, 600000.00, 350000.00, 250000.00, 180000.00, 80000.00, 120000.00, 1580000.00,
 5000000.00, 800000.00, 350000.00, 250000.00, 6400000.00, 7980000.00,
 1500000.00, 500000.00, 3500000.00, 4000000.00, -200000.00, 585000.00, 100000.00, 9985000.00, 17965000.00);


SELECT * FROM INCOMING_DATA_STAGING;

-- ============================================================================
-- Step 2: Execute Daily Data Insert
-- ============================================================================
CALL DAILY_DATA_INSERT();

-- Verify data was inserted
SELECT COUNT(*) AS TOTAL_RECORDS FROM ACTUAL_AA_BALANCE_SHEET;

SELECT * FROM ACTUAL_AA_BALANCE_SHEET;

-- View inserted data
SELECT 
    PORTFOLIO_TICKER,
    REPORTING_FREQUENCY,
    REPORTING_CURRENCY,
    VALUE_DATE,
    ACCT_BASIS,
    BALANCE_SHEET_TYPE,
    TOTAL_ASSETS,
    TOTAL_LIABILITIES,
    TOTAL_SHAREHOLDERS_EQUITY,
    CREATED_TIMESTAMP
FROM ACTUAL_AA_BALANCE_SHEET
ORDER BY PORTFOLIO_TICKER, ACCT_BASIS;

SELECT * FROM DELTA_EXPORT_HISTORY;

SELECT * FROM DAILY_DELTA_STAGING;

-- ============================================================================
-- Step 3: Check Stream for Changes
-- ============================================================================
-- After the insert, the stream should capture the changes
SELECT SYSTEM$STREAM_HAS_DATA('BALANCE_SHEET_CHANGES_STREAM') AS HAS_DATA;

SELECT * FROM BALANCE_SHEET_CHANGES_STREAM;

-- View stream contents (preview without consuming)
SELECT 
    PORTFOLIO_TICKER,
    ACCT_BASIS,
    TOTAL_ASSETS,
    METADATA$ACTION,
    METADATA$ISUPDATE,
    METADATA$ROW_ID
FROM BALANCE_SHEET_CHANGES_STREAM;

-- ============================================================================
-- Step 4: Export Delta to Parquet
-- ============================================================================
CALL EXPORT_DELTA_TO_PARQUET();

-- Check export history
SELECT * FROM DELTA_EXPORT_HISTORY ORDER BY EXPORT_TIMESTAMP DESC;


LS @DELTA_PARQUET_STAGE;

SELECT $1 FROM @delta_parquet_stage/balance_sheet_delta_20251211_134540.parquet;

-- ============================================================================
-- Step 5: Simulate Update (Day 2 Changes)
-- ============================================================================

-- Insert updated data for portfolio ABC with changed values
INSERT INTO INCOMING_DATA_STAGING (
    PORTFOLIO_TICKER, REPORTING_FREQUENCY, REPORTING_CURRENCY, VALUE_DATE,
    PRELIMINARY, SOURCE, ACCT_BASIS, BALANCE_SHEET_TYPE,
    CASH_AND_EQUIVALENTS, SHORT_TERM_INVESTMENTS, ACCOUNTS_RECEIVABLE, INVENTORY,
    PREPAID_EXPENSES, OTHER_CURRENT_ASSETS, TOTAL_CURRENT_ASSETS,
    LONG_TERM_INVESTMENTS, PROPERTY_PLANT_EQUIPMENT, ACCUMULATED_DEPRECIATION,
    INTANGIBLE_ASSETS, GOODWILL, OTHER_LONG_TERM_ASSETS, TOTAL_NON_CURRENT_ASSETS,
    TOTAL_ASSETS, ACCOUNTS_PAYABLE, SHORT_TERM_DEBT, ACCRUED_LIABILITIES,
    DEFERRED_REVENUE, CURRENT_PORTION_LONG_TERM_DEBT, OTHER_CURRENT_LIABILITIES,
    TOTAL_CURRENT_LIABILITIES, LONG_TERM_DEBT, DEFERRED_TAX_LIABILITIES,
    PENSION_LIABILITIES, OTHER_LONG_TERM_LIABILITIES, TOTAL_NON_CURRENT_LIABILITIES,
    TOTAL_LIABILITIES, COMMON_STOCK, PREFERRED_STOCK, ADDITIONAL_PAID_IN_CAPITAL,
    RETAINED_EARNINGS, TREASURY_STOCK, ACCUMULATED_OTHER_COMPREHENSIVE_INCOME,
    MINORITY_INTEREST, TOTAL_SHAREHOLDERS_EQUITY, TOTAL_LIABILITIES_AND_EQUITY
) VALUES
-- Updated Portfolio ABC - GAAP (Cash increased)
('ABC-001', 'DAILY', 'USD', CURRENT_DATE(), FALSE, 'ERP_SYSTEM', 'GAAP', 'CONSOLIDATED',
 1800000.00, 520000.00, 760000.00, 305000.00, 52000.00, 26000.00, 3463000.00,  -- Updated values
 2010000.00, 5020000.00, -1510000.00, 810000.00, 1210000.00, 102000.00, 7642000.00,
 11105000.00, 405000.00, 205000.00, 155000.00, 102000.00, 52000.00, 78000.00, 997000.00,
 3020000.00, 510000.00, 205000.00, 155000.00, 3890000.00, 4887000.00,
 1000000.00, 0.00, 2018000.00, 2800000.00, -100000.00, 400000.00, 100000.00, 6218000.00, 11105000.00),

-- New Portfolio JKL
('JKL-004', 'QUARTERLY', 'JPY', CURRENT_DATE(), FALSE, 'TREASURY_SYSTEM', 'GAAP', 'CONSOLIDATED',
 500000000.00, 200000000.00, 150000000.00, 80000000.00, 10000000.00, 5000000.00, 945000000.00,
 800000000.00, 2000000000.00, -600000000.00, 300000000.00, 450000000.00, 50000000.00, 3000000000.00,
 3945000000.00, 150000000.00, 75000000.00, 50000000.00, 40000000.00, 20000000.00, 30000000.00, 365000000.00,
 1200000000.00, 200000000.00, 80000000.00, 60000000.00, 1540000000.00, 1905000000.00,
 400000000.00, 100000000.00, 800000000.00, 650000000.00, -40000000.00, 100000000.00, 30000000.00, 2040000000.00, 3945000000.00);


SELECT * FROM INCOMING_DATA_STAGING;

SELECT * FROM ACTUAL_AA_BALANCE_SHEET;

SELECT * FROM BALANCE_SHEET_CHANGES_STREAM;

SELECT * FROM DAILY_DELTA_STAGING;

SELECT * FROM DELTA_EXPORT_HISTORY;

-- Execute daily insert to merge the updates
CALL DAILY_DATA_INSERT();

-- Verify updates
SELECT 
    PORTFOLIO_TICKER,
    ACCT_BASIS,
    CASH_AND_EQUIVALENTS,
    TOTAL_ASSETS,
    UPDATED_TIMESTAMP
FROM ACTUAL_AA_BALANCE_SHEET
WHERE PORTFOLIO_TICKER IN ('ABC-001', 'JKL-004')
ORDER BY PORTFOLIO_TICKER, ACCT_BASIS;

-- Check stream again
SELECT SYSTEM$STREAM_HAS_DATA('BALANCE_SHEET_CHANGES_STREAM') AS HAS_DATA;

-- Export new delta
CALL EXPORT_DELTA_TO_PARQUET();

-- View all exports
SELECT * FROM DELTA_EXPORT_HISTORY ORDER BY EXPORT_TIMESTAMP DESC;

-- ============================================================================
-- Step 6: Verify Parquet Files (with datetime-based naming)
-- ============================================================================

-- Read parquet file content (latest file)
SELECT $1 FROM @DELTA_PARQUET_STAGE (FILE_FORMAT => 'PARQUET_FORMAT') LIMIT 10;

LS @DELTA_PARQUET_STAGE;

-- ============================================================================
-- Step 7: Test Multiple Exports Per Day
-- ============================================================================

-- Simulate another change for same-day second export
INSERT INTO INCOMING_DATA_STAGING (
    PORTFOLIO_TICKER, REPORTING_FREQUENCY, REPORTING_CURRENCY, VALUE_DATE,
    PRELIMINARY, SOURCE, ACCT_BASIS, BALANCE_SHEET_TYPE,
    CASH_AND_EQUIVALENTS, SHORT_TERM_INVESTMENTS, ACCOUNTS_RECEIVABLE, INVENTORY,
    PREPAID_EXPENSES, OTHER_CURRENT_ASSETS, TOTAL_CURRENT_ASSETS,
    LONG_TERM_INVESTMENTS, PROPERTY_PLANT_EQUIPMENT, ACCUMULATED_DEPRECIATION,
    INTANGIBLE_ASSETS, GOODWILL, OTHER_LONG_TERM_ASSETS, TOTAL_NON_CURRENT_ASSETS,
    TOTAL_ASSETS, ACCOUNTS_PAYABLE, SHORT_TERM_DEBT, ACCRUED_LIABILITIES,
    DEFERRED_REVENUE, CURRENT_PORTION_LONG_TERM_DEBT, OTHER_CURRENT_LIABILITIES,
    TOTAL_CURRENT_LIABILITIES, LONG_TERM_DEBT, DEFERRED_TAX_LIABILITIES,
    PENSION_LIABILITIES, OTHER_LONG_TERM_LIABILITIES, TOTAL_NON_CURRENT_LIABILITIES,
    TOTAL_LIABILITIES, COMMON_STOCK, PREFERRED_STOCK, ADDITIONAL_PAID_IN_CAPITAL,
    RETAINED_EARNINGS, TREASURY_STOCK, ACCUMULATED_OTHER_COMPREHENSIVE_INCOME,
    MINORITY_INTEREST, TOTAL_SHAREHOLDERS_EQUITY, TOTAL_LIABILITIES_AND_EQUITY
) VALUES
-- Intraday update - Portfolio DEF with changed values
('DEF-002', 'DAILY', 'EUR', CURRENT_DATE(), FALSE, 'TRADING_SYSTEM', 'GAAP', 'STANDALONE',
 2100000.00, 890000.00, 680000.00, 0.00, 32000.00, 16000.00, 3678000.00,
 1550000.00, 3100000.00, -930000.00, 520000.00, 720000.00, 52000.00, 5012000.00,
 8690000.00, 320000.00, 160000.00, 110000.00, 85000.00, 42000.00, 53000.00, 770000.00,
 2600000.00, 420000.00, 160000.00, 110000.00, 3290000.00, 4060000.00,
 830000.00, 210000.00, 1550000.00, 1850000.00, -55000.00, 185000.00, 60000.00, 4630000.00, 8690000.00);

SELECT * FROM INCOMING_DATA_STAGING;

SELECT * FROM INCOMING_DATA_STAGING
UNION BY NAME
SELECT * FROM ACTUAL_AA_BALANCE_SHEET
WHERE PORTFOLIO_TICKER = 'DEF-002';

SELECT * FROM ACTUAL_AA_BALANCE_SHEET
WHERE PORTFOLIO_TICKER = 'DEF-002';

SELECT * FROM BALANCE_SHEET_CHANGES_STREAM;

SELECT * FROM DAILY_DELTA_STAGING;

SELECT * FROM DELTA_EXPORT_HISTORY;


-- Execute daily insert
CALL DAILY_DATA_INSERT();

-- Run SECOND export for the same day (creates new file with different timestamp)
CALL EXPORT_DELTA_TO_PARQUET();

-- Verify multiple exports for today
SELECT 
    EXPORT_DATE,
    EXPORT_TIMESTAMP,
    EXPORT_BATCH_ID,
    TOTAL_DELTA_RECORDS,
    PARQUET_FILE_PATH
FROM DELTA_EXPORT_HISTORY 
WHERE EXPORT_DATE = CURRENT_DATE()
ORDER BY EXPORT_TIMESTAMP;

-- View updated daily summary showing multiple exports
SELECT * FROM DELTA_EXPORT_HISTORY WHERE EXPORT_DATE = CURRENT_DATE();


LS @DELTA_PARQUET_STAGE;

SELECT $1 FROM @delta_parquet_stage/balance_sheet_delta_20251212_082831.parquet;

SELECT $1 FROM @delta_parquet_stage/balance_sheet_delta_20251212_082644.parquet;